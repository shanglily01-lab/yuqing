# 外部访问配置指南

## 1. 检查应用配置

确保应用监听 `0.0.0.0` 而不是 `127.0.0.1`，这样才能从外部访问。

### 检查 config.py

```bash
cd ~/yuqing
grep "HOST" config.py
```

应该看到：
```python
HOST: str = Field("0.0.0.0", ...)
```

### 检查 .env 文件

```bash
cd ~/yuqing
grep "HOST" .env
```

如果没有设置，添加：
```bash
HOST=0.0.0.0
PORT=5000
```

## 2. 配置EC2安全组（AWS控制台）

### 步骤：

1. 登录 AWS 控制台
2. 进入 EC2 服务
3. 选择您的实例
4. 点击 "Security" 标签页
5. 点击安全组名称
6. 点击 "Edit inbound rules"
7. 添加以下规则：

| 类型 | 协议 | 端口范围 | 来源 |
|------|------|----------|------|
| 自定义TCP | TCP | 5000 | 0.0.0.0/0 (或您的IP) |
| 自定义TCP | TCP | 8501 | 0.0.0.0/0 (或您的IP) |
| 自定义TCP | TCP | 8502 | 0.0.0.0/0 (或您的IP) |
| 自定义TCP | TCP | 8503 | 0.0.0.0/0 (或您的IP) |
| SSH | TCP | 22 | 您的IP (保持安全) |

**注意**：为了安全，建议将来源设置为您的IP地址，而不是 `0.0.0.0/0`。

## 3. 配置服务器防火墙

### Amazon Linux 2023 (使用firewalld)

```bash
# 检查防火墙状态
sudo systemctl status firewalld

# 如果防火墙未运行，启动它
sudo systemctl start firewalld
sudo systemctl enable firewalld

# 添加端口规则
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --permanent --add-port=8501/tcp
sudo firewall-cmd --permanent --add-port=8502/tcp
sudo firewall-cmd --permanent --add-port=8503/tcp

# 重新加载防火墙
sudo firewall-cmd --reload

# 验证规则
sudo firewall-cmd --list-ports
```

### Amazon Linux 2 (使用iptables)

```bash
# 添加规则
sudo iptables -A INPUT -p tcp --dport 5000 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 8501 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 8502 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 8503 -j ACCEPT

# 保存规则（Amazon Linux 2）
sudo service iptables save
```

## 4. 获取EC2实例的公网IP

```bash
# 方法1：从EC2实例内部
curl http://169.254.169.254/latest/meta-data/public-ipv4

# 方法2：从AWS控制台查看
# EC2 Dashboard -> Instances -> 选择实例 -> 查看 Public IPv4 address
```

## 5. 访问应用

### Flask主应用
```
http://<EC2公网IP>:5000
```

### Streamlit子应用
```
http://<EC2公网IP>:8501  # QueryEngine
http://<EC2公网IP>:8502  # MediaEngine
http://<EC2公网IP>:8503  # InsightEngine
```

## 6. 测试连接

### 从本地测试

```bash
# 测试Flask应用
curl http://<EC2公网IP>:5000

# 测试Streamlit应用
curl http://<EC2公网IP>:8501
```

### 从浏览器访问

直接在浏览器中输入：
```
http://<EC2公网IP>:5000
```

## 7. 使用域名访问（可选）

如果您有域名，可以：

1. 配置DNS A记录指向EC2公网IP
2. 使用Nginx作为反向代理
3. 配置SSL证书（HTTPS）

### Nginx配置示例

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

## 8. 常见问题排查

### 问题1：无法连接

**检查清单：**
- [ ] 安全组规则已添加
- [ ] 防火墙端口已开放
- [ ] 应用监听 `0.0.0.0` 而不是 `127.0.0.1`
- [ ] 应用正在运行
- [ ] 使用正确的公网IP

### 问题2：连接超时

```bash
# 检查应用是否在运行
ps aux | grep python

# 检查端口是否监听
sudo netstat -tlnp | grep 5000
# 或
sudo ss -tlnp | grep 5000

# 检查防火墙
sudo firewall-cmd --list-all
```

### 问题3：403 Forbidden

检查安全组规则，确保来源IP正确。

## 9. 安全建议

1. **限制访问来源**：在安全组中只允许特定IP访问
2. **使用HTTPS**：配置SSL证书
3. **使用VPN**：通过VPN访问，不暴露公网
4. **定期更新**：保持系统和依赖包更新
5. **监控日志**：定期检查访问日志

## 10. 快速配置脚本

```bash
#!/bin/bash
# 快速配置防火墙（Amazon Linux 2023）

# 添加端口
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --permanent --add-port=8501/tcp
sudo firewall-cmd --permanent --add-port=8502/tcp
sudo firewall-cmd --permanent --add-port=8503/tcp

# 重新加载
sudo firewall-cmd --reload

# 显示配置
echo "防火墙配置完成！"
echo "开放的端口："
sudo firewall-cmd --list-ports

# 显示公网IP
echo "公网IP："
curl -s http://169.254.169.254/latest/meta-data/public-ipv4
```

保存为 `setup_firewall.sh`，然后运行：
```bash
chmod +x setup_firewall.sh
./setup_firewall.sh
```

