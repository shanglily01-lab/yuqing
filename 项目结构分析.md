# BettaFish（微舆）项目结构分析

## 📋 项目概述

**BettaFish（微舆）** 是一个从0实现的创新型**多智能体舆情分析系统**，帮助用户破除信息茧房，还原舆情原貌，预测未来走向，辅助决策。用户只需像聊天一样提出分析需求，智能体开始全自动分析国内外30+主流社媒与数百万条大众评论。

## 🏗️ 整体架构

### 核心设计理念

系统采用**多智能体协作架构**，通过以下机制实现高质量分析：

1. **并行处理**：三个专业Agent（Query、Media、Insight）同时工作
2. **论坛协作**：ForumEngine作为主持人，协调Agent之间的讨论与协作
3. **深度分析**：每个Agent具备独特的工具集和思维模式
4. **报告生成**：ReportEngine整合所有分析结果，生成专业报告

### 系统流程图

```
用户提问 → Flask主应用
    ↓
并行启动三个Agent
    ├─ Query Agent（新闻搜索）
    ├─ Media Agent（多模态分析）
    └─ Insight Agent（数据库挖掘）
    ↓
初步分析 → 制定策略
    ↓
循环阶段（多轮）
    ├─ 深度研究（各Agent专项搜索）
    ├─ 论坛协作（ForumEngine协调）
    └─ 交流融合（Agent调整方向）
    ↓
结果整合 → Report Agent生成报告
```

## 📁 项目目录结构

```
BettaFish-main/
│
├── 📄 核心配置文件
│   ├── app.py                    # Flask主应用入口（统一管理所有组件）
│   ├── config.py                 # 全局配置文件（基于Pydantic Settings）
│   ├── requirements.txt          # Python依赖包清单
│   ├── docker-compose.yml        # Docker编排配置
│   └── Dockerfile                # Docker镜像构建文件
│
├── 🤖 智能体引擎（Engine）
│   │
│   ├── QueryEngine/              # 国内外新闻广度搜索Agent
│   │   ├── agent.py              # Agent主逻辑
│   │   ├── llms/                 # LLM接口封装
│   │   │   └── base.py           # 统一的OpenAI兼容客户端
│   │   ├── nodes/                # 处理节点（工作流节点）
│   │   │   ├── base_node.py      # 基础节点类
│   │   │   ├── search_node.py    # 搜索节点
│   │   │   ├── summary_node.py   # 总结节点
│   │   │   ├── report_structure_node.py  # 报告结构节点
│   │   │   └── formatting_node.py        # 格式化节点
│   │   ├── tools/                # 搜索工具
│   │   │   └── search.py         # Tavily新闻搜索工具
│   │   ├── state/                # 状态管理
│   │   │   └── state.py          # Agent状态定义
│   │   ├── prompts/              # 提示词模板
│   │   │   └── prompts.py        # 各类提示词
│   │   └── utils/                # 工具函数
│   │       ├── config.py         # 配置管理
│   │       └── text_processing.py # 文本处理
│   │
│   ├── MediaEngine/              # 强大的多模态理解Agent
│   │   ├── agent.py              # Agent主逻辑
│   │   ├── llms/                 # LLM接口
│   │   ├── nodes/                # 处理节点（与QueryEngine类似）
│   │   ├── tools/                # 搜索工具
│   │   │   └── search.py         # Bocha多模态搜索工具
│   │   ├── state/                # 状态管理
│   │   ├── prompts/              # 提示词模板
│   │   └── utils/                # 工具函数
│   │
│   ├── InsightEngine/            # 私有数据库挖掘Agent
│   │   ├── agent.py              # Agent主逻辑
│   │   ├── llms/                 # LLM接口封装
│   │   ├── nodes/                # 处理节点
│   │   ├── tools/                # 数据库查询和分析工具
│   │   │   ├── search.py         # 数据库操作工具集
│   │   │   ├── keyword_optimizer.py  # Qwen关键词优化中间件
│   │   │   └── sentiment_analyzer.py # 情感分析集成工具
│   │   ├── state/                # 状态管理
│   │   ├── prompts/              # 提示词模板
│   │   └── utils/                # 工具函数
│   │       └── db.py             # 数据库连接工具
│   │
│   ├── ReportEngine/             # 多轮报告生成Agent
│   │   ├── agent.py              # Agent主逻辑
│   │   ├── flask_interface.py    # Flask API接口
│   │   ├── llms/                 # LLM接口
│   │   ├── nodes/                # 报告生成节点
│   │   │   ├── template_selection.py  # 模板选择节点
│   │   │   └── html_generation.py     # HTML生成节点
│   │   ├── report_template/      # 报告模板库
│   │   │   ├── 社会公共热点事件分析报告模板.md
│   │   │   ├── 企业品牌声誉分析报告模板.md
│   │   │   ├── 突发事件与危机公关舆情报告模板.md
│   │   │   └── ...               # 更多模板
│   │   ├── state/                # 状态管理
│   │   └── utils/                # 工具函数
│   │
│   └── ForumEngine/              # 论坛引擎（协调机制）
│       ├── monitor.py            # 日志监控和论坛管理
│       └── llm_host.py           # 论坛主持人LLM模块
│
├── 🕷️ 数据采集系统
│   └── MindSpider/               # 微博爬虫系统
│       ├── main.py               # 爬虫主程序
│       ├── config.py             # 爬虫配置文件
│       │
│       ├── BroadTopicExtraction/ # 话题提取模块
│       │   ├── database_manager.py   # 数据库管理器
│       │   ├── get_today_news.py     # 今日新闻获取
│       │   ├── main.py               # 话题提取主程序
│       │   └── topic_extractor.py    # 话题提取器
│       │
│       ├── DeepSentimentCrawling/    # 深度舆情爬取
│       │   ├── keyword_manager.py    # 关键词管理器
│       │   ├── main.py               # 深度爬取主程序
│       │   ├── platform_crawler.py   # 平台爬虫管理
│       │   └── MediaCrawler/         # 媒体爬虫核心（支持多平台）
│       │       ├── media_platform/   # 各平台爬虫实现
│       │       │   ├── weibo/        # 微博爬虫
│       │       │   ├── xhs/          # 小红书爬虫
│       │       │   ├── douyin/       # 抖音爬虫
│       │       │   ├── kuaishou/     # 快手爬虫
│       │       │   ├── bilibili/     # B站爬虫
│       │       │   ├── zhihu/        # 知乎爬虫
│       │       │   └── tieba/        # 贴吧爬虫
│       │       ├── database/         # 数据库操作
│       │       ├── cache/            # 缓存机制
│       │       ├── proxy/            # 代理管理
│       │       └── tools/            # 工具函数
│       │
│       └── schema/                # 数据库结构
│           ├── db_manager.py      # 数据库管理器
│           ├── init_database.py   # 数据库初始化
│           ├── models_sa.py       # SQLAlchemy模型
│           ├── models_bigdata.py  # 大数据模型
│           └── mindspider_tables.sql  # 数据库表结构
│
├── 🧠 情感分析模型
│   └── SentimentAnalysisModel/   # 情感分析模型集合
│       ├── WeiboMultilingualSentiment/    # 多语言情感分析（推荐）
│       ├── WeiboSentiment_SmallQwen/      # 小参数Qwen3微调
│       ├── WeiboSentiment_Finetuned/      # 微调BERT/GPT-2模型
│       │   ├── BertChinese-Lora/          # BERT中文LoRA微调
│       │   ├── GPT2-Lora/                 # GPT-2 LoRA微调
│       │   └── GPT2-AdapterTuning/        # GPT-2 Adapter微调
│       └── WeiboSentiment_MachineLearning/ # 传统机器学习方法
│           ├── svm_train.py               # SVM训练
│           ├── lstm_train.py              # LSTM训练
│           ├── bert_train.py              # BERT训练
│           └── xgboost_train.py           # XGBoost训练
│
├── 🖥️ 前端应用
│   ├── SingleEngineApp/          # 单独Agent的Streamlit应用
│   │   ├── query_engine_streamlit_app.py   # QueryEngine界面
│   │   ├── media_engine_streamlit_app.py   # MediaEngine界面
│   │   └── insight_engine_streamlit_app.py # InsightEngine界面
│   │
│   ├── templates/                # Flask模板
│   │   └── index.html            # 主界面前端（统一管理界面）
│   │
│   └── static/                   # 静态资源
│       └── image/                # 图片资源
│
├── 📊 数据输出目录
│   ├── logs/                     # 运行日志目录
│   │   ├── insight.log           # InsightEngine日志
│   │   ├── media.log             # MediaEngine日志
│   │   ├── query.log             # QueryEngine日志
│   │   └── forum.log             # ForumEngine日志
│   │
│   ├── final_reports/            # 最终生成的HTML报告文件
│   │
│   ├── insight_engine_streamlit_reports/  # InsightEngine报告
│   ├── media_engine_streamlit_reports/    # MediaEngine报告
│   └── query_engine_streamlit_reports/    # QueryEngine报告
│
├── 🛠️ 工具函数
│   └── utils/                    # 通用工具函数
│       ├── forum_reader.py       # Agent间论坛通信
│       ├── retry_helper.py       # 网络请求重试机制工具
│       └── github_issues.py      # GitHub Issues工具
│
└── 🧪 测试
    └── tests/                    # 测试代码
        ├── test_monitor.py       # ForumEngine监控测试
        ├── forum_log_test_data.py # 测试数据
        └── run_tests.py          # 测试运行器
```

## 🔧 核心组件详解

### 1. Flask主应用（app.py）

**职责**：
- 统一管理所有Streamlit子应用
- 提供WebSocket实时通信
- 协调ForumEngine和ReportEngine
- 提供配置管理API
- 系统启动和状态管理

**关键功能**：
- 启动/停止三个Streamlit应用（Query、Media、Insight）
- 监控日志文件变化并推送到前端
- 管理ForumEngine的启动和停止
- 提供统一的搜索接口

### 2. 智能体引擎架构

每个Engine都遵循相同的架构模式：

```
Agent (agent.py)
    ├── LLM Client (llms/)          # LLM接口封装
    ├── Nodes (nodes/)              # 工作流节点
    │   ├── Search Node             # 搜索节点
    │   ├── Summary Node            # 总结节点
    │   ├── Report Structure Node   # 报告结构节点
    │   └── Formatting Node         # 格式化节点
    ├── Tools (tools/)              # 工具集
    ├── State (state/)              # 状态管理
    ├── Prompts (prompts/)          # 提示词模板
    └── Utils (utils/)              # 工具函数
```

#### 2.1 QueryEngine（查询引擎）

**功能**：国内外新闻广度搜索
- **工具**：Tavily News Agency API
- **特点**：专注于新闻和网页搜索
- **LLM推荐**：DeepSeek Reasoner

#### 2.2 MediaEngine（媒体引擎）

**功能**：多模态内容分析
- **工具**：Bocha多模态搜索API
- **特点**：支持图片、视频、结构化信息卡片分析
- **LLM推荐**：Gemini 2.5 Pro

#### 2.3 InsightEngine（洞察引擎）

**功能**：私有数据库深度挖掘
- **工具**：
  - MediaCrawlerDB（数据库查询）
  - Keyword Optimizer（关键词优化）
  - Sentiment Analyzer（情感分析）
- **特点**：分析爬取的舆情数据，支持情感分析
- **LLM推荐**：Kimi K2

#### 2.4 ReportEngine（报告引擎）

**功能**：智能报告生成
- **特点**：
  - 动态选择报告模板
  - 多轮生成优化
  - HTML格式输出
- **LLM推荐**：Gemini 2.5 Pro

### 3. ForumEngine（论坛引擎）

**职责**：协调多个Agent的协作

**工作机制**：
1. 监控三个Engine的日志文件（insight.log, media.log, query.log）
2. 提取Agent的Summary输出
3. 通过LLM主持人总结讨论内容
4. 生成引导性发言，推动Agent深入分析
5. 将讨论内容写入forum.log

**关键特性**：
- 实时监控日志变化
- 智能触发主持人发言
- 避免Agent思维同质化
- 促进集体智能

### 4. MindSpider（爬虫系统）

**功能**：数据采集和预处理

**主要模块**：

#### 4.1 BroadTopicExtraction（话题提取）
- 获取今日新闻
- 提取热点话题
- 生成关键词

#### 4.2 DeepSentimentCrawling（深度爬取）
- 支持多平台爬取（微博、小红书、抖音、快手、B站、知乎、贴吧）
- 爬取内容和评论
- 数据存储到数据库

**支持的平台**：
- 微博（Weibo）
- 小红书（Xiaohongshu）
- 抖音（Douyin）
- 快手（Kuaishou）
- B站（Bilibili）
- 知乎（Zhihu）
- 百度贴吧（Tieba）

### 5. 情感分析模型

**多种实现方式**：
1. **多语言情感分析**（推荐）：支持中英文
2. **Qwen3微调**：小参数模型，速度快
3. **BERT微调**：中文情感分析
4. **GPT-2微调**：生成式情感分析
5. **传统机器学习**：SVM、LSTM、XGBoost等

## 🔄 工作流程

### 完整分析流程

1. **用户提问**
   - 用户在Flask主界面输入查询
   - 系统接收并分发任务

2. **并行启动**
   - 同时启动Query、Media、Insight三个Agent
   - 每个Agent开始独立工作

3. **初步分析**
   - 各Agent使用专属工具进行概览搜索
   - 生成初步分析结果

4. **策略制定**
   - 基于初步结果，各Agent制定分块研究策略
   - 确定需要深入研究的领域

5. **循环阶段（多轮）**
   - **深度研究**：各Agent基于策略进行专项搜索
   - **论坛协作**：ForumEngine监控Agent发言，生成主持人总结
   - **交流融合**：各Agent根据讨论调整研究方向
   - 重复此过程，直到达到深度要求

6. **结果整合**
   - ReportEngine收集所有分析结果和论坛内容
   - 选择最合适的报告模板

7. **报告生成**
   - 多轮生成和优化
   - 输出HTML格式的最终报告

## 🗄️ 数据流

```
数据采集（MindSpider）
    ↓
数据库存储（MySQL/PostgreSQL）
    ↓
InsightEngine查询分析
    ↓
情感分析处理
    ↓
结果整合到报告
```

## 🔌 技术栈

### 后端
- **Web框架**：Flask + Flask-SocketIO
- **异步框架**：Streamlit（各Engine界面）
- **数据库**：MySQL/PostgreSQL（SQLAlchemy ORM）
- **LLM接口**：OpenAI兼容格式（支持多种提供商）

### 数据处理
- **爬虫**：Playwright + BeautifulSoup
- **数据处理**：Pandas + NumPy
- **文本处理**：Jieba（中文分词）

### 机器学习
- **深度学习**：PyTorch + Transformers
- **传统ML**：Scikit-learn + XGBoost
- **情感分析**：多种预训练和微调模型

### 部署
- **容器化**：Docker + Docker Compose
- **配置管理**：Pydantic Settings + .env文件

## 📝 配置文件说明

### config.py
- 使用Pydantic Settings管理配置
- 支持从.env文件和环境变量加载
- 包含所有Engine的API配置
- 数据库连接配置
- 搜索API配置

### .env文件
- 数据库连接信息
- 各Engine的LLM API密钥和配置
- 搜索API密钥（Tavily、Bocha等）

## 🚀 部署方式

### 1. Docker部署（推荐）
```bash
docker compose up -d
```

### 2. 源码部署
```bash
# 安装依赖
pip install -r requirements.txt

# 配置.env文件
cp .env.example .env
# 编辑.env文件

# 初始化数据库
cd MindSpider
python main.py --setup

# 启动主应用
python app.py
```

## 🎯 核心优势

1. **多智能体协作**：三个专业Agent并行工作，ForumEngine协调
2. **多模态支持**：支持文本、图片、视频分析
3. **深度分析**：结合LLM和传统ML模型
4. **灵活扩展**：模块化设计，易于添加新功能
5. **统一管理**：Flask主应用统一管理所有组件

## 📚 扩展性

### 添加新的Agent
1. 创建新的Engine目录
2. 实现agent.py、nodes、tools等模块
3. 在app.py中注册新的Streamlit应用
4. 在ForumEngine中添加监控

### 添加新的数据源
1. 在MindSpider/DeepSentimentCrawling/MediaCrawler中添加新平台爬虫
2. 实现对应的client.py和core.py
3. 更新数据库模型

### 添加新的分析模型
1. 在SentimentAnalysisModel中添加新模型
2. 在InsightEngine/tools中集成
3. 更新配置文件

## 🔍 关键设计模式

1. **节点模式（Node Pattern）**：每个Engine使用节点链式处理
2. **状态模式（State Pattern）**：使用State类管理Agent状态
3. **工具模式（Tool Pattern）**：每个Agent有专属工具集
4. **观察者模式（Observer Pattern）**：ForumEngine监控日志变化
5. **策略模式（Strategy Pattern）**：支持多种LLM和模型选择

## 📌 注意事项

1. **API密钥配置**：需要配置多个LLM API密钥
2. **数据库初始化**：首次运行需要初始化数据库
3. **爬虫合规**：遵守目标网站的robots.txt和使用条款
4. **资源消耗**：多Agent并行运行需要足够的计算资源
5. **日志管理**：日志文件会持续增长，需要定期清理

---

**总结**：BettaFish是一个设计精良的多智能体舆情分析系统，通过模块化架构、多Agent协作和丰富的工具集，实现了高质量的舆情分析能力。系统具有良好的扩展性，可以轻松添加新的Agent、数据源和分析模型。

