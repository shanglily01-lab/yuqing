# 502 Bad Gateway 错误排查指南

## 问题原因

502错误通常表示：
1. 应用没有运行
2. 应用崩溃了
3. 端口没有正确监听
4. 应用启动时出错

## 排查步骤

### 1. 检查应用是否在运行

```bash
# 检查Python进程
ps aux | grep python

# 检查特定端口
sudo netstat -tlnp | grep 5000
# 或
sudo ss -tlnp | grep 5000
```

### 2. 检查应用日志

```bash
cd ~/yuqing
tail -f logs/*.log

# 或者查看最近的错误
tail -100 logs/*.log | grep -i error
```

### 3. 检查应用是否能正常启动

```bash
cd ~/yuqing
source venv/bin/activate
export PYTHONPATH=$(pwd):$PYTHONPATH

# 尝试启动应用
python app.py
```

### 4. 检查端口监听状态

```bash
# 检查5000端口是否被占用
sudo lsof -i :5000

# 检查所有Python相关端口
sudo netstat -tlnp | grep python
```

### 5. 检查防火墙

```bash
# 检查防火墙状态
sudo firewall-cmd --list-all

# 检查端口是否开放
sudo firewall-cmd --list-ports
```

### 6. 检查安全组

确保AWS安全组中：
- 端口5000已开放
- 来源设置为 0.0.0.0/0 或您的IP

## 常见解决方案

### 方案1：应用没有运行

```bash
cd ~/yuqing
source venv/bin/activate
export PYTHONPATH=$(pwd):$PYTHONPATH

# 后台运行
nohup python app.py > logs/app.log 2>&1 &

# 或者使用screen
screen -S bettafish
python app.py
# 按 Ctrl+A 然后 D 退出screen
```

### 方案2：端口被占用

```bash
# 查找占用5000端口的进程
sudo lsof -i :5000

# 杀死进程（替换PID为实际进程ID）
sudo kill -9 <PID>
```

### 方案3：使用Systemd服务

```bash
cd ~/yuqing

# 复制服务文件
sudo cp deploy/bettafish.service /etc/systemd/system/

# 编辑服务文件，确保路径正确
sudo nano /etc/systemd/system/bettafish.service

# 重新加载systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start bettafish

# 查看状态
sudo systemctl status bettafish

# 查看日志
sudo journalctl -u bettafish -f
```

### 方案4：检查依赖和配置

```bash
cd ~/yuqing
source venv/bin/activate

# 检查依赖
pip list | grep -E "flask|streamlit"

# 检查配置文件
cat .env | grep -E "HOST|PORT"
```

## 快速诊断脚本

```bash
#!/bin/bash
echo "=== 诊断信息 ==="
echo "1. 检查Python进程："
ps aux | grep python | grep -v grep

echo -e "\n2. 检查端口监听："
sudo netstat -tlnp | grep -E "5000|8501|8502|8503"

echo -e "\n3. 检查防火墙："
sudo firewall-cmd --list-ports

echo -e "\n4. 检查应用日志（最后20行）："
tail -20 ~/yuqing/logs/*.log 2>/dev/null || echo "没有日志文件"

echo -e "\n5. 检查.env配置："
grep -E "HOST|PORT" ~/yuqing/.env 2>/dev/null || echo ".env文件不存在或没有HOST/PORT配置"
```

保存为 `diagnose.sh`，运行：
```bash
chmod +x diagnose.sh
./diagnose.sh
```

