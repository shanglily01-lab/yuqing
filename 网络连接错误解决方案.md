# 网络连接错误解决方案

## 错误信息

```
peer closed connection without sending complete message body (incomplete chunked read)
```

## 问题原因

这个错误通常表示：
1. **API服务器端主动关闭了连接**（服务器负载过高、超时等）
2. **网络不稳定**（网络波动、连接中断）
3. **请求超时**（请求时间过长，服务器主动断开）
4. **请求体过大**（发送的数据量超过服务器限制）
5. **API服务商限流**（请求频率过高被限制）

## 解决方案

### 方案1：增加重试机制和超时设置

#### 1.1 检查当前超时设置

查看各Engine的配置文件中的超时设置：

```bash
cd ~/yuqing
grep -r "TIMEOUT\|timeout" config.py InsightEngine/utils/config.py QueryEngine/utils/config.py MediaEngine/utils/config.py
```

#### 1.2 增加超时时间

在 `.env` 文件中增加超时设置：

```bash
# 增加API超时时间（秒）
API_TIMEOUT=300  # 从默认的240秒增加到300秒
SEARCH_TIMEOUT=300  # 搜索超时时间
```

### 方案2：优化请求大小

#### 2.1 减少请求内容长度

在 `.env` 文件中限制内容长度：

```bash
# 减少最大内容长度
MAX_CONTENT_LENGTH=100000  # 从默认值减少
SEARCH_CONTENT_MAX_LENGTH=10000  # 减少搜索内容长度
```

#### 2.2 分批处理数据

如果处理大量数据，考虑分批处理而不是一次性发送。

### 方案3：添加重试逻辑

#### 3.1 检查重试配置

查看是否有重试机制，如果没有，需要添加。

#### 3.2 增加重试次数和延迟

在 `.env` 文件中配置：

```bash
# 增加重试次数
MAX_RETRIES=5  # 默认可能是3，增加到5

# 增加重试延迟
MAX_RETRY_DELAY=60  # 重试延迟（秒）
```

### 方案4：检查网络连接

#### 4.1 测试API连接

```bash
# 测试API服务器连接
curl -I https://api.deepseek.com
curl -I https://api.moonshot.cn/v1
curl -I https://aihubmix.com/v1
```

#### 4.2 检查网络稳定性

```bash
# 测试网络延迟
ping api.deepseek.com
ping api.moonshot.cn
```

### 方案5：使用更稳定的API服务

#### 5.1 切换到更稳定的API服务商

如果当前使用的API服务不稳定，考虑切换：

**DeepSeek**（推荐，稳定性好）
```bash
QUERY_ENGINE_API_KEY=your_deepseek_key
QUERY_ENGINE_BASE_URL=https://api.deepseek.com
QUERY_ENGINE_MODEL_NAME=deepseek-reasoner
```

**OpenAI**（最稳定，但价格较高）
```bash
QUERY_ENGINE_API_KEY=your_openai_key
QUERY_ENGINE_BASE_URL=https://api.openai.com/v1
QUERY_ENGINE_MODEL_NAME=gpt-4
```

#### 5.2 使用中转API服务

中转API服务通常更稳定：

```bash
# 使用aihubmix中转服务
MEDIA_ENGINE_API_KEY=your_aihubmix_key
MEDIA_ENGINE_BASE_URL=https://aihubmix.com/v1
MEDIA_ENGINE_MODEL_NAME=gemini-2.5-pro
```

### 方案6：降低请求频率

#### 6.1 减少并发请求

如果同时发送多个请求，可能导致连接被关闭。减少并发数量。

#### 6.2 增加请求间隔

在请求之间添加延迟，避免请求过于频繁。

### 方案7：检查服务器资源

#### 7.1 检查EC2服务器资源

```bash
# 检查CPU使用率
top

# 检查内存使用
free -h

# 检查网络连接
netstat -an | grep ESTABLISHED | wc -l
```

#### 7.2 检查API使用情况

登录API服务商控制台，查看：
- API调用频率
- 是否有限流
- 错误日志

## 快速修复步骤

### 步骤1：更新超时和重试配置

```bash
cd ~/yuqing
nano .env
```

添加或更新以下配置：

```bash
# 增加超时时间
API_TIMEOUT=300
SEARCH_TIMEOUT=300

# 增加重试次数
MAX_RETRIES=5
MAX_RETRY_DELAY=60

# 减少内容长度（如果请求过大）
MAX_CONTENT_LENGTH=100000
SEARCH_CONTENT_MAX_LENGTH=10000
```

### 步骤2：重启应用

```bash
cd ~/yuqing

# 停止应用
pkill -f "python.*app.py"
pkill -f streamlit
sleep 2

# 重新启动
source venv/bin/activate
export PYTHONPATH=$(pwd):$PYTHONPATH
nohup python app.py > logs/app.log 2>&1 &
```

### 步骤3：监控日志

```bash
# 查看应用日志
tail -f logs/app.log

# 查看Streamlit日志
tail -f logs/*.log
```

## 临时解决方案

如果问题持续存在，可以：

1. **降低请求复杂度**：使用更简单的查询，减少数据量
2. **分批处理**：将大任务拆分成多个小任务
3. **使用缓存**：缓存结果，减少重复请求
4. **切换API服务**：尝试使用其他API服务商

## 预防措施

1. **监控API使用**：定期检查API调用情况
2. **设置告警**：在API服务商处设置使用量告警
3. **优化代码**：减少不必要的API调用
4. **使用连接池**：复用连接，减少连接开销
5. **实现重试机制**：自动重试失败的请求

## 常见场景

### 场景1：处理大量数据时出错

**解决方案**：
- 减少 `MAX_CONTENT_LENGTH`
- 分批处理数据
- 增加超时时间

### 场景2：频繁请求时出错

**解决方案**：
- 降低请求频率
- 增加请求间隔
- 检查是否被限流

### 场景3：网络不稳定

**解决方案**：
- 增加重试次数
- 增加重试延迟
- 检查网络连接

### 场景4：API服务器负载过高

**解决方案**：
- 切换到其他API服务
- 在非高峰时段使用
- 联系API服务商

## 调试命令

```bash
# 查看详细的错误日志
cd ~/yuqing
tail -100 logs/*.log | grep -i "error\|timeout\|connection"

# 测试API连接
curl -v -X POST https://api.deepseek.com/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{"model":"deepseek-reasoner","messages":[{"role":"user","content":"test"}]}'

# 检查网络连接数
netstat -an | grep ESTABLISHED | wc -l

# 检查是否有连接泄漏
lsof -i -P -n | grep python
```

## 如果问题持续

1. **联系API服务商**：询问是否有服务问题
2. **检查API文档**：查看是否有特殊要求或限制
3. **查看错误日志**：获取更详细的错误信息
4. **尝试其他API**：验证是否是特定API的问题

