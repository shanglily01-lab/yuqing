# 修复导入错误 - 完整方案

## 问题

`ModuleNotFoundError: No module named 'InsightEngine.utils.config'`

## 原因

1. 代码中使用了绝对导入，但Python路径配置不正确
2. Python缓存文件（.pyc）可能包含旧的导入信息
3. EC2服务器上的代码可能没有更新

## 完整解决方案

### 步骤1：更新代码

```bash
cd ~/yuqing
git pull origin main
```

### 步骤2：清理Python缓存

```bash
cd ~/yuqing

# 删除所有Python缓存文件
find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null || true
find . -name "*.pyc" -delete
find . -name "*.pyo" -delete

# 或者使用Python命令清理
python3 -Bc "import pathlib; [p.unlink() for p in pathlib.Path('.').rglob('*.py[co]')]"
python3 -Bc "import pathlib; [p.rmdir() for p in pathlib.Path('.').rglob('__pycache__')]"
```

### 步骤3：验证文件存在

```bash
cd ~/yuqing
ls -la InsightEngine/utils/config.py
ls -la InsightEngine/utils/__init__.py
```

### 步骤4：测试导入

```bash
cd ~/yuqing
source venv/bin/activate
export PYTHONPATH=$(pwd):$PYTHONPATH

# 测试导入
python -c "from InsightEngine.utils.config import settings; print('导入成功')"
```

### 步骤5：重新启动应用

```bash
cd ~/yuqing

# 停止所有进程
pkill -f "python.*app.py"
pkill -f streamlit
sleep 2

# 清理缓存
find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null || true
find . -name "*.pyc" -delete

# 重新启动
source venv/bin/activate
export PYTHONPATH=$(pwd):$PYTHONPATH
nohup python app.py > logs/app.log 2>&1 &

# 等待启动
sleep 10

# 检查状态
ps aux | grep -E "python.*app.py|streamlit"
```

## 一键修复脚本

```bash
cd ~/yuqing
cat > fix_imports.sh << 'EOF'
#!/bin/bash

echo "=== 修复导入错误 ==="

# 1. 更新代码
echo "1. 更新代码..."
git pull origin main

# 2. 清理Python缓存
echo "2. 清理Python缓存..."
find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null || true
find . -name "*.pyc" -delete
find . -name "*.pyo" -delete

# 3. 验证文件
echo "3. 验证文件..."
if [ -f "InsightEngine/utils/config.py" ]; then
    echo "✓ InsightEngine/utils/config.py 存在"
else
    echo "✗ InsightEngine/utils/config.py 不存在"
    exit 1
fi

# 4. 测试导入
echo "4. 测试导入..."
source venv/bin/activate
export PYTHONPATH=$(pwd):$PYTHONPATH

if python -c "from InsightEngine.utils.config import settings; print('导入成功')" 2>&1; then
    echo "✓ 导入测试成功"
else
    echo "✗ 导入测试失败"
    echo "尝试使用相对导入测试..."
    cd InsightEngine/utils
    if python -c "from .config import settings; print('相对导入成功')" 2>&1; then
        echo "✓ 相对导入成功"
    else
        echo "✗ 相对导入也失败"
        exit 1
    fi
    cd ../..
fi

# 5. 停止现有进程
echo "5. 停止现有进程..."
pkill -f "python.*app.py" || true
pkill -f streamlit || true
sleep 2

# 6. 重新启动
echo "6. 重新启动应用..."
nohup python app.py > logs/app.log 2>&1 &

sleep 10

# 7. 检查状态
echo "7. 检查状态..."
echo "Flask应用:"
ps aux | grep "python.*app.py" | grep -v grep || echo "未运行"

echo -e "\nStreamlit应用:"
ps aux | grep streamlit | grep -v grep || echo "未运行"

echo -e "\n端口监听:"
sudo netstat -tlnp | grep -E "5000|8501|8502|8503" || echo "没有端口在监听"

echo -e "\n完成！"
EOF

chmod +x fix_imports.sh
./fix_imports.sh
```

## 如果仍然失败

### 检查PYTHONPATH

```bash
cd ~/yuqing
source venv/bin/activate
export PYTHONPATH=$(pwd):$PYTHONPATH

# 验证PYTHONPATH
echo $PYTHONPATH
python -c "import sys; print('\n'.join(sys.path))"
```

### 手动测试导入路径

```bash
cd ~/yuqing
source venv/bin/activate
export PYTHONPATH=$(pwd):$PYTHONPATH

# 进入InsightEngine目录测试
cd InsightEngine
python -c "from utils.config import settings; print('成功')"
cd ..

# 从项目根目录测试
python -c "from InsightEngine.utils.config import settings; print('成功')"
```

### 检查文件权限

```bash
ls -la InsightEngine/utils/config.py
ls -la InsightEngine/utils/__init__.py
```

确保文件有读取权限。

## 替代方案：修改导入方式

如果相对导入仍然有问题，可以尝试修改 `InsightEngine/utils/db.py` 和 `InsightEngine/tools/search.py`，使用更明确的导入方式。

